apiVersion: v1
kind: ConfigMap
metadata:
  labels:
    deploy: sourcegraph
    sourcegraph-resource-requires: no-cluster-admin
    app.kubernetes.io/component: prometheus
  name: prometheus
data:
  prometheus.yml: "# Prometheus global config\nglobal:\n  scrape_interval:     30s\n  evaluation_interval: 30s\n  # scrape_timeout is set to the global default (10s).\n\n# Alertmanager configuration\nalerting:\n  alertmanagers:\n    # bundled alertmanager, started by prom-wrapper\n    - static_configs:\n        - targets: ['127.0.0.1:9093']\n      path_prefix: /alertmanager\n    # add more alertmanagers here\n\n# Load rules once and periodically evaluate them according to the global 'evaluation_interval'.\nrule_files:\n  - '/sg_config_prometheus/*_rules.yml'\n  - '/sg_prometheus_add_ons/*_rules.yml'\n\n# Configure targets to scrape\nscrape_configs:\n\n  # Scrape prometheus itself for metrics.\n  - job_name: 'builtin-prometheus'\n    static_configs:\n      - targets: ['127.0.0.1:9092']\n\n  - job_name: 'builtin-alertmanager'\n    metrics_path: /alertmanager/metrics\n    static_configs:\n      - targets: ['127.0.0.1:9093']\n\n  - job_name: 'sourcegraph-services'\n    relabel_configs:\n      - source_labels: [__address__]\n        target_label: instance\n        regex: (.*)\\.(.*)\n        replacement: ${1}_${2}\n    metric_relabel_configs:\n      - source_labels: [container_label_io_kubernetes_pod_namespace]\n        regex: kube-system\n        action: drop\n    file_sd_configs:\n      - files:\n          - '/sg_prometheus_add_ons/*_targets.yml'\n  \n  - job_name: 'cadvisor'\n    dns_sd_configs:\n      - names:\n        - 'cadvisor.default.svc.cluster.local'\n        - 'cadvisor.ns-sourcegraph.svc.cluster.local'\n        type: A\n        port: 48080\n    relabel_configs:\n      - source_labels: [__address__]\n        target_label: instance\n        regex: (.*)\\.(.*)\n        replacement: ${1}_${2}\n      - source_labels: [container_label_io_kubernetes_pod_name]\n        target_label: name\n    metric_relabel_configs:\n      - source_labels: [container_label_io_kubernetes_pod_namespace]\n        regex: kube-system\n        action: drop\n      - source_labels: [container_label_io_kubernetes_container_name, container_label_io_kubernetes_pod_name]\n        regex: (.+)\n        action: replace\n        target_label: name\n        separator: '-'\n      # - source_labels: [container_label_io_kubernetes_pod_namespace]\n      #   regex: ^$|ns-sourcegraph # ACTION: replace ns-sourcegraph with your namespace\n      #   action: keep\n  \n  - job_name: 'sourcegraph-statefulsets'\n    dns_sd_configs:\n      - names:\n        - 'symbols.default.svc.cluster.local'\n        - 'symbols.ns-sourcegraph.svc.cluster.local'\n        - 'searcher.default.svc.cluster.local'\n        - 'searcher.ns-sourcegraph.svc.cluster.local'\n        - 'gitserver.default.svc.cluster.local'\n        - 'gitserver.ns-sourcegraph.svc.cluster.local'\n        - 'sourcegraph-frontend.default.svc.cluster.local'\n        - 'sourcegraph-frontend.ns-sourcegraph.svc.cluster.local'\n        type: A\n        port: 6060\n      - names:\n        - 'indexed-search.default.svc.cluster.local'\n        - 'indexed-search.ns-sourcegraph.svc.cluster.local'\n        type: A\n        port: 6070\n      - names:\n        - 'indexed-search-indexer.default.svc.cluster.local'\n        - 'indexed-search-indexer.ns-sourcegraph.svc.cluster.local'\n        type: A\n        port: 6072\n    relabel_configs:\n      - source_labels: [__meta_dns_name]\n        target_label: service_name\n        regex: (.*)\\..*\\..*\\..*\\..*\n        replacement: ${1}\n"
  # Extra rules
  extra_rules.yml: |
    groups:
    - name: container.rules
      rules:
        - record: container:process_cpu_seconds_total:ratio_rate5m
          expr: sum by (instance) (rate(process_cpu_seconds_total[5m])) / engine_daemon_engine_cpus_cpus
        - record: container:process_cpu_seconds_total:sum
          expr: sum by (instance) (irate(process_cpu_seconds_total[1m]))
        - record: container:process_resident_memory_bytes:max
          expr: max by (instance) (process_resident_memory_bytes)
        - record: container:process_virtual_memory_bytes:max
          expr: max by (instance) (process_virtual_memory_bytes)
  # List of static targets
  prometheus_targets.yml: |
    - labels:
        nodename: "sourcegraph-services"
        job: cadvisor
      targets:
        - cadvisor:48080
    - labels:
        nodename: "sourcegraph-services"
        job: sourcegraph-frontend
      targets:
        - sourcegraph-frontend:6060
    - labels:
        nodename: "sourcegraph-services"
        job: github-proxy
      targets:
        - github-proxy:6060
    - labels:
        nodename: "sourcegraph-services"
        job: repo-updater
      targets:
        - repo-updater:6060
    - labels:
        nodename: "sourcegraph-services"
        job: worker
      targets:
        - worker:6060
    - labels:
        nodename: "sourcegraph-services"
        job: worker-executors
      targets:
        - worker-executors:6996
    - labels:
        nodename: "sourcegraph-services"
        job: syntect-server
      targets:
        - syntect-server:6060
    - labels:
        nodename: "sourcegraph-services"
        job: precise-code-intel-worker
      targets:
        - precise-code-intel-worker:6060
    - labels:
        nodename: "sourcegraph-services"
        job: pgsql
      targets:
        - pgsql:9187
    - labels:
        nodename: "sourcegraph-services"
        job: codeintel-db
      targets:
        - codeintel-db:9187
    - labels:
        nodename: "sourcegraph-services"
        job: codeinsights-db
      targets:
        - codeinsights-db:9187
    - labels:
        nodename: "sourcegraph-services"
        job: redis-cache
      targets:
        - redis-cache:9121
    - labels:
        nodename: "sourcegraph-services"
        job: redis-store
      targets:
        - redis-store:9121
    - labels:
        nodename: "sourcegraph-services"
        job: node-exporter
      targets:
        - node-exporter:9100
    - labels:
        nodename: "sourcegraph-services"
        job: otel-collector
      targets:
        - otel-collector:8888
  # Add new targets based on replica count of symbols
  symbols_targets.yml: |
    - labels:
        nodename: "sourcegraph-services"
        job: symbols
      targets:
        - symbols-0.symbols:6060
  # Add new targets based on replica count of searcher
  searcher_targets.yml: |
    - labels:
        nodename: "sourcegraph-services"
        job: searcher
      targets:
        - searcher-0.searcher:6060
  # Add new targets based on replica count of gitserver
  gitserver_targets.yml: |
    - labels:
        nodename: "sourcegraph-services"
        job: gitserver
      targets:
        - gitserver-0.gitserver:6060
  # Add new targets based on replica count of indexed-search
  indexed-search_targets.yml: |
    - labels:
        nodename: "sourcegraph-services"
        job: zoekt-indexserver
      targets:
        - indexed-search-0.indexed-search:6072
    - labels:
        nodename: "sourcegraph-services"
        job: zoekt-webserver
      targets:
        - indexed-search-0.indexed-search:6070
