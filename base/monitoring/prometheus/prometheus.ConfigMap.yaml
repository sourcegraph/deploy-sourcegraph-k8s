apiVersion: v1
kind: ConfigMap
metadata:
  labels:
    deploy: sourcegraph
    sourcegraph-resource-requires: no-cluster-admin
    app.kubernetes.io/component: prometheus
  name: prometheus
data:
  prometheus.yml: |
    # Prometheus global config
    global:
      scrape_interval:     30s
      evaluation_interval: 30s
      # scrape_timeout is set to the global default (10s).

    # Alertmanager configuration
    alerting:
      alertmanagers:
        # bundled alertmanager, started by prom-wrapper
        - static_configs:
            - targets: ['127.0.0.1:9093']
          path_prefix: /alertmanager
        # add more alertmanagers here

    # Load rules once and periodically evaluate them according to the global 'evaluation_interval'.
    rule_files:
      - '/sg_config_prometheus/*_rules.yml'
      - '/sg_prometheus_add_ons/*_rules.yml'

    # Configure targets to scrape
    scrape_configs:

      # Scrape prometheus itself for metrics.
      - job_name: 'builtin-prometheus'
        static_configs:
          - targets: ['127.0.0.1:9092']

      - job_name: 'builtin-alertmanager'
        metrics_path: /alertmanager/metrics
        static_configs:
          - targets: ['127.0.0.1:9093']

      - job_name: 'sourcegraph-services'
        relabel_configs:
          - source_labels: [__address__]
            target_label: instance
            regex: (.*)\.(.*)
            replacement: ${1}_${2}
        metric_relabel_configs:
          - source_labels: [container_label_io_kubernetes_pod_namespace]
            regex: kube-system
            action: drop
        file_sd_configs:
          - files:
              - '/sg_prometheus_add_ons/*_targets.yml'
      
      - job_name: 'cadvisor'
        static_configs:
          - targets: ['cadvisor:48080']
        relabel_configs:
          - source_labels: [__address__]
            target_label: instance
            regex: (.*)\.(.*)
            replacement: ${1}_${2}
          - source_labels: [container_label_io_kubernetes_pod_name]
            target_label: name
        metric_relabel_configs:
          - source_labels: [container_label_io_kubernetes_pod_namespace]
            regex: kube-system
            action: drop
          - source_labels: [container_label_io_kubernetes_container_name, container_label_io_kubernetes_pod_name]
            regex: (.+)
            action: replace
            target_label: name
            separator: '-'

  # Extra rules
  extra_rules.yml: |
    groups:
    - name: container.rules
      rules:
        - record: container:process_cpu_seconds_total:ratio_rate5m
          expr: sum by (instance) (rate(process_cpu_seconds_total[5m])) / engine_daemon_engine_cpus_cpus
        - record: container:process_cpu_seconds_total:sum
          expr: sum by (instance) (irate(process_cpu_seconds_total[1m]))
        - record: container:process_resident_memory_bytes:max
          expr: max by (instance) (process_resident_memory_bytes)
        - record: container:process_virtual_memory_bytes:max
          expr: max by (instance) (process_virtual_memory_bytes)

  # List of static targets
  prometheus_targets.yml: |
    - labels:
        nodename: "sourcegraph-services"
        job: sourcegraph-frontend
      targets:
        - sourcegraph-frontend:6060
    - labels:
        nodename: "sourcegraph-services"
        job: github-proxy
      targets:
        - github-proxy:6060
    - labels:
        nodename: "sourcegraph-services"
        job: repo-updater
      targets:
        - repo-updater:6060
    - labels:
        nodename: "sourcegraph-services"
        job: worker
      targets:
        - worker:6060
    - labels:
        nodename: "sourcegraph-services"
        job: worker-executors
      targets:
        - worker-executors:6996
    - labels:
        nodename: "sourcegraph-services"
        job: syntect-server
      targets:
        - syntect-server:6060
    - labels:
        nodename: "sourcegraph-services"
        job: precise-code-intel-worker
      targets:
        - precise-code-intel-worker:6060
    - labels:
        nodename: "sourcegraph-services"
        job: pgsql
      targets:
        - pgsql:9187
    - labels:
        nodename: "sourcegraph-services"
        job: codeintel-db
      targets:
        - codeintel-db:9187
    - labels:
        nodename: "sourcegraph-services"
        job: codeinsights-db
      targets:
        - codeinsights-db:9187
    - labels:
        nodename: "sourcegraph-services"
        job: redis-cache
      targets:
        - redis-cache:9121
    - labels:
        nodename: "sourcegraph-services"
        job: redis-store
      targets:
        - redis-store:9121
    - labels:
        nodename: "sourcegraph-services"
        job: node-exporter
      targets:
        - node-exporter:9100
    - labels:
        nodename: "sourcegraph-services"
        job: otel-collector
      targets:
        - otel-collector:8888

  # Add new targets based on replica count of symbols
  symbols_targets.yml: |
    - labels:
        nodename: "sourcegraph-services"
        job: symbols
      targets:
        - symbols-0.symbols:6060

  # Add new targets based on replica count of searcher
  searcher_targets.yml: |
    - labels:
        nodename: "sourcegraph-services"
        job: searcher
      targets:
        - searcher-0.searcher:6060

  # Add new targets based on replica count of gitserver
  gitserver_targets.yml: |
    - labels:
        nodename: "sourcegraph-services"
        job: gitserver
      targets:
        - gitserver-0.gitserver:6060

  # Add new targets based on replica count of indexed-search
  indexed-search_targets.yml: |
    - labels:
        nodename: "sourcegraph-services"
        job: zoekt-indexserver
      targets:
        - indexed-search-0.indexed-search:6072
    - labels:
        nodename: "sourcegraph-services"
        job: zoekt-webserver
      targets:
        - indexed-search-0.indexed-search:6070
