apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
############################################################################
#
# HOW TO USE:
#
# Follow our docs to uncomment the components/section below
# to configure your Sourcegraph deployment
#
# Docs:
# https://docs.sourcegraph.com/admin/deploy/kubernetes/kustomize/configure
#
############################################################################
# Resources for all Sourcegraph services with default settings
resources:
  - ../../base/sourcegraph

############################################################################
# NAMESPACE
############################################################################
# Update namespace for resources generated by this overlay
namespace: default

############################################################################
# COMPONENTS
############################################################################
components:
  # Add resources for Sourcegraph monitoring stacks
  # RBACs required
  - ../../components/monitoring

  # Update the following env vars in the **FRONTEND ENV VARS**
  # section located at the bottom of this file:
  # - PRIVATE_REGISTRY
  - ../../components/private-registry

  # Disable or enable rockskip
  - ../../components/disable/rockskip # Disable
  - ../../components/enable/rockskip # Enable

  # Use nodeport 30080
  - ../../components/nodeport/30080

  # Remove all daemonsets resources
  - ../../components/remove/daemonset

  # Remove cadvisor
  - ../../components/remove/cadvisor

  # Remove the default ingress from frontend
  - ../../components/remove/default-ingress

  # Remove all pvcs resources
  - ../../components/remove/pvcs

  # Remove all container resources (Limits, requests)
  - ../../components/remove/resources

  # Update network-policy
  - ../../components/network-policy

  # Use custom redis servers
  # Update the following env vars in the **FRONTEND ENV VARS**
  # section located at the bottom of this file:
  # REDIS_CACHE_ENDPOINT & REDIS_STORE_ENDPOINT
  - ../../components/redis

  # Use ssh to clon repositories
  # Also see GENERATE SECRETS sections for importing ssh files
  - ../../components/ssh/non-root # Non-root user
  - ../../components/ssh/root # Root user

  # Create storage class resources for cloud providers
  - ../../components/storage-class/aws # For aws
  - ../../components/storage-class/azure # For azure
  - ../../components/storage-class/gcp # For gcp

  # For other cloud providers
  #
  # Update env vars below in the **FRONTEND ENV VARS**
  # section located at the bottom of this file:
  # - STORAGECLASS_NAME
  # - STORAGECLASS_PROVISIONER
  # - STORAGECLASS_PARAM_TYPE
  - ../../components/storage-class/cloud

  # Create resources to use local SSDs - RBACs required
  #
  # Update the following env vars in the **FRONTEND ENV VARS**
  # section located at the bottom of this file:
  # - SSD_NODE_PATH
  - ../../components/ssd

  # To enable TLS
  #
  # Update env vars below in the **FRONTEND ENV VARS**
  # section located at the bottom of this file:
  # - TLS_HOST
  # - TLS_INGRESS_CLASS_NAME
  # - TLS_CLUSTER_ISSUER

  # Add tls.crt & tls.key to the config directory
  # Then uncomment all TLS fields in "secretGenerator" section below
  - ../../components/tls

  # Add tls.crt & tls.key to the config directory
  # Then uncomment all TLS fields in "secretGenerator" section below
  - ../../components/uid

  # Run as arbitrary users in all Postgres database
  - ../../components/enable/service-discovery

############################################################################
# UPDATE REPLICA COUNTS
############################################################################
# Services that are not in the list below do not require
# more than one replica
replicas:
  - name: gitserver
    count: 1
  - name: searcher
    count: 1
  - name: symbols
    count: 1
  - name: indexed-search
    count: 1
  - name: sourcegraph-frontend
    count: 2
  - name: precise-code-intel-worker
    count: 1

############################################################################
# UPDATE CONFIGMAP
############################################################################
patchesStrategicMerge:
  - patches/prometheus.ConfigMap.yaml
  - patches/pgsql.ConfigMap.yaml
  - patches/otel-collector.ConfigMap.yaml
  - patches/custom.NodePort.yaml
#
############################################################################
# UPDATE ANNOTATIONS
############################################################################
patchesJson6902:
  - target:
      version: v1
      kind: Ingress
      name: sourcegraph-frontend
    path: patches/frontend-ingress.annotations.yaml

############################################################################
# GENERATE SECRETS
############################################################################
secretGenerator:
  - name: sourcegraph-frontend-tls
    behavior: create
    files:
      - tls.crt
      - tls.key
      - additional.file
      - additional.file
      - additional.file

  # Generate secrets for gitserver to use ssh
  - name: gitserver-ssh
    files:
      - id_rsa
      - known_hosts

  # Generate secrets for database
  - name: dbs-secrets
    files:
      - secrets.env
      - additional.file
      - additional.file
      - additional.file
      - additional.file
      - additional.file

############################################################################
# DO NOT REMOVE: Handle updating endpoints configs for frontend
############################################################################
replacements:
  - source:
      kind: StatefulSet
      fieldPath: spec.replicas
      name: gitserver
    targets:
      - select: &endpoints-map
          kind: ConfigMap
          name: sourcegraph-frontend-env
        fieldPaths:
          - data.GITSERVER_REPLICA_COUNT
  - source:
      kind: StatefulSet
      fieldPath: spec.replicas
      name: indexed-search
    targets:
      - select: *endpoints-map
        fieldPaths:
          - data.INDEXED_SEARCH_REPLICA_COUNT
  - source:
      kind: StatefulSet
      fieldPath: spec.replicas
      name: searcher
    targets:
      - select: *endpoints-map
        fieldPaths:
          - data.SEARCHER_REPLICA_COUNT
  - source:
      kind: StatefulSet
      fieldPath: spec.replicas
      name: symbols
    targets:
      - select: *endpoints-map
        fieldPaths:
          - data.SYMBOLS_REPLICA_COUNT

############################################################################
# CONFIGURATIONS FOR OVERLAY COMPONENTS
############################################################################
configMapGenerator:
  - name: sourcegraph-frontend-env
    behavior: merge
    env: env/frontend.env
  # Handle updating configs using env vars for kustomize
  - name: sourcegraph-kustomize-env
    behavior: merge
    literals:
      - NAME=sourcegraph-kustomize
      # - TLS_HOST=
      # - TLS_INGRESS_CLASS_NAME=
      # - TLS_CLUSTER_ISSUER=
      # - STORAGECLASS_NAME=
      # - STORAGECLASS_PROVISIONER=
      # - STORAGECLASS_PARAM_TYPE=
      # - PRIVATE_REGISTRY=

  ############################################################################
  # FRONTEND ENV VARS
  ############################################################################
  # Handle updating env vars for frontend
  - name: sourcegraph-frontend-env
    behavior: merge
    literals:
      - DEPLOY_TYPE=kubernetes
      # Add env var as instructed below this line
